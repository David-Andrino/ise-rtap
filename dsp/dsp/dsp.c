#include "dsp.h"
#include "arm_math.h"

static dsp_coefs_t current_levels = { 0 };
static float auxBuffer[DSP_BUF_SIZE];

static const q31_t coeffs[DSP_BANDS][DSP_LEVELS][10] = {
    { // BAND 1
        { 536013181, -1072026363, 536013181, 1073741824, -536870912, 536013181, -1063677598, 527728935, 1061930361, -525187972, }, // -6 dB
        { 536443447, -1072886894, 536443447, 1073741824, -536870912, 536443447, -1063777945, 527411186, 1062907350, -526144676, }, // -3 dB
        { 536870912, -1073741824, 536870912, 1073741824, -536870912, 536870912, -1063803543, 527023777, 1063803543, -527023777, }, // 0 dB
        { 537298718, -1074597435, 537298718, 1073741824, -536870912, 537298718, -1063754328, 526563934, 1064625617, -527831454, }, // 3 dB
        { 537730015, -1075460030, 537730015, 1073741824, -536870912, 537730015, -1063629666, 526028380, 1065379699, -528573409, }, // 6 dB
    }, { // BAND 2
        { 533494678, -1058816094, 525467240, 1065939047, -529157961, 533494678, -1041032161, 508925950, 1033429976, -498812573, }, // -6 dB
        { 535186068, -1062167969, 527113032, 1065725420, -528957385, 535186068, -1041335703, 507699125, 1037541500, -502645399, }, // -3 dB
        { 536870912, -1065581413, 528827349, 1065581413, -528827349, 536870912, -1041262354, 506135953, 1041262354, -506135953, }, // 0 dB
        { 538561061, -1069080480, 530622620, 1065511830, -528772462, 538561061, -1040807833, 504227800, 1044613981, -509297437, }, // 3 dB
        { 540268512, -1072684867, 532506750, 1065516837, -528792672, 540268512, -1039970063, 501969320, 1047620358, -512146700, }, // 6 dB
    }, { // BAND 3
        { 524884763, -1012968199, 491470256, 1036407567, -501810737, 524884763, -947377809, 443679533, 918521018, -413116221, }, // -6 dB
        { 530862111, -1024158905, 496420407, 1035884447, -501573457, 530862111, -947598385, 439988777, 933176909, -424639872, }, // -3 dB
        { 536870912, -1035670279, 501655630, 1035670279, -501655630, 536870912, -946413508, 435254839, 946413508, -435254839, }, // 0 dB
        { 542947726, -1047609569, 507250741, 1035751307, -502039364, 542947726, -943739490, 429446349, 958324201, -444968987, }, // 3 dB
        { 549130774, -1060074734, 513269973, 1036100110, -502693359, 549130774, -939496155, 422550049, 969011913, -453811298, }, // 6 dB
    }, { // BAND 4
        { 508052536, -874935599, 411746438, 927604291, -424422151, 508052536, -671478538, 335026905, 596558312, -284920289, }, // -6 dB
        { 522293635, -899319903, 419828635, 925848177, -426083491, 522293635, -666333963, 328953368, 628572440, -303470012, }, // -3 dB
        { 536870912, -924815881, 428498454, 924815881, -428498454, 536870912, -657985147, 321253420, 657985147, -321253420, }, // 0 dB
        { 551855042, -951688708, 437975532, 924420027, -431546101, 551855042, -646115970, 311939896, 684931422, -338134495, }, // 3 dB
        { 567323959, -980220994, 448496743, 924564764, -435102022, 567323959, -630397020, 301081886, 709566963, -354030710, }, // 6 dB
    }, { // BAND 5
        { 431841949, -586290861, 229212798, 820624988, -335007540, 431841949, 586290861, 229212798, -820624988, -335007540, }, // -6 dB
        { 481482377, -676122557, 266693475, 799776409, -322554559, 481482377, 676122557, 266693475, -799776409, -322554559, }, // -3 dB
        { 536870912, -777538408, 309962566, 777538408, -309962566, 536870912, 777538408, 309962566, -777538408, -309962566, }, // 0 dB
        { 598631206, -891780698, 359660433, 753902014, -297373230, 598631206, 891780698, 359660433, -753902014, -297373230, }, // 3 dB
        { 667444134, -1020210487, 416485252, 728883588, -284960004, 667444134, 1020210487, 416485252, -728883588, -284960004, }, // 6 dB
    }
};

static q15_t stateVars[DSP_BANDS][4 * DSP_NUM_STAGES];

void dsp_init(dsp_coefs_t levels) {
    for (int i = 0; i < DSP_BANDS; i++) {
        current_levels[i] = levels[i];
        arm_biquad_cascade_df1_init_q15(
            &insts[i], DSP_NUM_STAGES,
            coeffs[i][levels[i]], stateVars[i], DSP_POST_SHIFT
        );
    }
}

void dsp_process_buffer(uint16_t* in, uint16_t* out, uint32_t bufSize) {
    // Usar arm_shift_q15, arm_shift_offset
    
    q15_t testArr[] = { -1, 2048, -2, 2, 100, 150 };
    q15_t testTwo[] = {  0,    0,  0, 0, 250, -50 };
    arm_add_q15(testArr, testTwo, testArr, 6);
    float32_t destArr[] = { 0 };
    arm_q15_to_float(testArr, destArr, 6);
    (void)destArr;
    
    
    /*
    arm_offset_q15(in, (q15_t)2048, in, bufSize);
    arm_biquad_cascade_df1_q15(&insts[0], (q15_t*)in, (q15_t*)out, bufSize);
    for (int i = 1; i < DSP_BANDS; i++) {
        arm_biquad_cascade_df1_q15(&insts[i], (q15_t*)out, (q15_t*)out, bufSize);
    }
    */
}
